<!DOCTYPE html>
<!-- Generated by pkgdown: do not edit by hand --><html lang="en">
<head>
<meta http-equiv="Content-Type" content="text/html; charset=UTF-8">
<meta charset="utf-8">
<meta http-equiv="X-UA-Compatible" content="IE=edge">
<meta name="viewport" content="width=device-width, initial-scale=1, shrink-to-fit=no">
<title>Demonstration: simulation study • fastRG</title>
<script src="../deps/jquery-3.6.0/jquery-3.6.0.min.js"></script><meta name="viewport" content="width=device-width, initial-scale=1, shrink-to-fit=no">
<link href="../deps/bootstrap-5.3.1/bootstrap.min.css" rel="stylesheet">
<script src="../deps/bootstrap-5.3.1/bootstrap.bundle.min.js"></script><link href="../deps/font-awesome-6.5.2/css/all.min.css" rel="stylesheet">
<link href="../deps/font-awesome-6.5.2/css/v4-shims.min.css" rel="stylesheet">
<script src="../deps/headroom-0.11.0/headroom.min.js"></script><script src="../deps/headroom-0.11.0/jQuery.headroom.min.js"></script><script src="../deps/bootstrap-toc-1.0.1/bootstrap-toc.min.js"></script><script src="../deps/clipboard.js-2.0.11/clipboard.min.js"></script><script src="../deps/search-1.0.0/autocomplete.jquery.min.js"></script><script src="../deps/search-1.0.0/fuse.min.js"></script><script src="../deps/search-1.0.0/mark.min.js"></script><!-- pkgdown --><script src="../pkgdown.js"></script><meta property="og:title" content="Demonstration: simulation study">
<meta name="robots" content="noindex">
</head>
<body>
    <a href="#main" class="visually-hidden-focusable">Skip to contents</a>


    <nav class="navbar navbar-expand-lg fixed-top bg-primary" data-bs-theme="dark" aria-label="Site navigation"><div class="container">

    <a class="navbar-brand me-2" href="../index.html">fastRG</a>

    <small class="nav-text text-danger me-auto" data-bs-toggle="tooltip" data-bs-placement="bottom" title="In-development version">0.3.3.9002</small>


    <button class="navbar-toggler" type="button" data-bs-toggle="collapse" data-bs-target="#navbar" aria-controls="navbar" aria-expanded="false" aria-label="Toggle navigation">
      <span class="navbar-toggler-icon"></span>
    </button>

    <div id="navbar" class="collapse navbar-collapse ms-3">
      <ul class="navbar-nav me-auto">
<li class="nav-item"><a class="nav-link" href="../reference/index.html">Reference</a></li>
<li class="active nav-item dropdown">
  <button class="nav-link dropdown-toggle" type="button" id="dropdown-articles" data-bs-toggle="dropdown" aria-expanded="false" aria-haspopup="true">Articles</button>
  <ul class="dropdown-menu" aria-labelledby="dropdown-articles">
<li><a class="dropdown-item" href="../articles/consistency.html">Demonstration: simulation study</a></li>
  </ul>
</li>
<li class="nav-item"><a class="nav-link" href="../news/index.html">Changelog</a></li>
      </ul>
<ul class="navbar-nav">
<li class="nav-item"><form class="form-inline" role="search">
 <input class="form-control" type="search" name="search-input" id="search-input" autocomplete="off" aria-label="Search site" placeholder="Search for" data-search-index="../search.json">
</form></li>
<li class="nav-item"><a class="external-link nav-link" href="https://github.com/RoheLab/fastRG/" aria-label="GitHub"><span class="fa fab fa-github fa-lg"></span></a></li>
      </ul>
</div>


  </div>
</nav><div class="container template-article">




<div class="row">
  <main id="main" class="col-md-9"><div class="page-header">

      <h1>Demonstration: simulation study</h1>
            
      
      <small class="dont-index">Source: <a href="https://github.com/RoheLab/fastRG/blob/main/vignettes/consistency.Rmd" class="external-link"><code>vignettes/consistency.Rmd</code></a></small>
      <div class="d-none name"><code>consistency.Rmd</code></div>
    </div>

    
    
<p>In this vignette we demonstrate how to use the <code>fastRG</code>
package to study the finite sample performance of two spectral
estimators, the Adjacency Spectral Embedding and the Laplacian Spectral
Embedding.</p>
<p>We’ll consider how these estimators perform in two different cases: a
stochastic blockmodel where the signal eigenvalues are all
well-separated, and a stochastic blockmodel with exactly repeated
eigenvalues. We define the data generating process as follows:</p>
<div class="sourceCode" id="cb1"><pre class="downlit sourceCode r">
<code class="sourceCode R"><span><span class="kw"><a href="https://rdrr.io/r/base/library.html" class="external-link">library</a></span><span class="op">(</span><span class="va"><a href="https://dplyr.tidyverse.org" class="external-link">dplyr</a></span><span class="op">)</span></span>
<span><span class="kw"><a href="https://rdrr.io/r/base/library.html" class="external-link">library</a></span><span class="op">(</span><span class="va"><a href="https://ggplot2.tidyverse.org" class="external-link">ggplot2</a></span><span class="op">)</span></span>
<span><span class="kw"><a href="https://rdrr.io/r/base/library.html" class="external-link">library</a></span><span class="op">(</span><span class="va"><a href="https://rohelab.github.io/fastRG/">fastRG</a></span><span class="op">)</span></span>
<span><span class="kw"><a href="https://rdrr.io/r/base/library.html" class="external-link">library</a></span><span class="op">(</span><span class="va">irlba</span><span class="op">)</span></span>
<span><span class="kw"><a href="https://rdrr.io/r/base/library.html" class="external-link">library</a></span><span class="op">(</span><span class="va"><a href="https://Matrix.R-forge.R-project.org" class="external-link">Matrix</a></span><span class="op">)</span></span>
<span><span class="kw"><a href="https://rdrr.io/r/base/library.html" class="external-link">library</a></span><span class="op">(</span><span class="va"><a href="https://purrr.tidyverse.org/" class="external-link">purrr</a></span><span class="op">)</span></span>
<span><span class="kw"><a href="https://rdrr.io/r/base/library.html" class="external-link">library</a></span><span class="op">(</span><span class="va"><a href="https://scales.r-lib.org" class="external-link">scales</a></span><span class="op">)</span></span>
<span><span class="kw"><a href="https://rdrr.io/r/base/library.html" class="external-link">library</a></span><span class="op">(</span><span class="va"><a href="https://tidyr.tidyverse.org" class="external-link">tidyr</a></span><span class="op">)</span></span>
<span></span>
<span><span class="fu"><a href="https://rdrr.io/r/base/Random.html" class="external-link">set.seed</a></span><span class="op">(</span><span class="fl">27</span><span class="op">)</span></span>
<span></span>
<span><span class="va">model_distinct</span> <span class="op">&lt;-</span> <span class="kw">function</span><span class="op">(</span><span class="va">n</span>, <span class="va">k</span> <span class="op">=</span> <span class="fl">5</span><span class="op">)</span> <span class="op">{</span></span>
<span>  <span class="va">B</span> <span class="op">&lt;-</span> <span class="fu"><a href="https://rdrr.io/r/base/matrix.html" class="external-link">matrix</a></span><span class="op">(</span><span class="fl">0.05</span>, nrow <span class="op">=</span> <span class="va">k</span>, ncol <span class="op">=</span> <span class="va">k</span><span class="op">)</span></span>
<span>  <span class="fu"><a href="https://rdrr.io/r/base/diag.html" class="external-link">diag</a></span><span class="op">(</span><span class="va">B</span><span class="op">)</span> <span class="op">&lt;-</span> <span class="fu"><a href="https://rdrr.io/r/base/seq.html" class="external-link">seq</a></span><span class="op">(</span><span class="fl">0.8</span>, <span class="fl">0.4</span>, length.out <span class="op">=</span> <span class="va">k</span><span class="op">)</span></span>
<span>  <span class="va">latent</span> <span class="op">&lt;-</span> <span class="fu"><a href="../reference/dcsbm.html">dcsbm</a></span><span class="op">(</span></span>
<span>    theta <span class="op">=</span> <span class="fu"><a href="https://rdrr.io/r/stats/Exponential.html" class="external-link">rexp</a></span><span class="op">(</span><span class="va">n</span><span class="op">)</span> <span class="op">+</span> <span class="fl">1</span>,</span>
<span>    B <span class="op">=</span> <span class="va">B</span>,</span>
<span>    expected_degree <span class="op">=</span> <span class="fl">0.1</span> <span class="op">*</span> <span class="va">n</span></span>
<span>  <span class="op">)</span></span>
<span><span class="op">}</span></span>
<span></span>
<span><span class="va">model_repeated</span> <span class="op">&lt;-</span> <span class="kw">function</span><span class="op">(</span><span class="va">n</span>, <span class="va">k</span> <span class="op">=</span> <span class="fl">5</span><span class="op">)</span> <span class="op">{</span></span>
<span>  <span class="va">latent</span> <span class="op">&lt;-</span> <span class="fu"><a href="../reference/dcsbm.html">dcsbm</a></span><span class="op">(</span></span>
<span>    theta <span class="op">=</span> <span class="fu"><a href="https://rdrr.io/r/base/rep.html" class="external-link">rep</a></span><span class="op">(</span><span class="fl">1</span>, <span class="va">n</span><span class="op">)</span>,</span>
<span>    B <span class="op">=</span> <span class="fu"><a href="https://rdrr.io/r/base/diag.html" class="external-link">diag</a></span><span class="op">(</span><span class="fl">0.5</span>, <span class="va">k</span><span class="op">)</span>,</span>
<span>    expected_degree <span class="op">=</span> <span class="fl">0.1</span> <span class="op">*</span> <span class="va">n</span></span>
<span>  <span class="op">)</span></span>
<span><span class="op">}</span></span></code></pre></div>
<p>Now, if we want to compare the population singular values of the
distinct eigenvalue model with the sample singular values, we could do
so as follows:</p>
<div class="sourceCode" id="cb2"><pre class="downlit sourceCode r">
<code class="sourceCode R"><span><span class="co"># sample the latent parameters of the blockmodel</span></span>
<span><span class="va">latent</span> <span class="op">&lt;-</span> <span class="fu">model_distinct</span><span class="op">(</span><span class="fl">1000</span><span class="op">)</span></span>
<span></span>
<span><span class="co"># compute the population singular value decomposition of the blockmodel</span></span>
<span><span class="va">s_pop</span> <span class="op">&lt;-</span> <span class="fu"><a href="https://rdrr.io/pkg/RSpectra/man/svds.html" class="external-link">svds</a></span><span class="op">(</span><span class="va">latent</span><span class="op">)</span></span>
<span></span>
<span><span class="co"># sample a network conditional on the latent factors</span></span>
<span><span class="va">A</span> <span class="op">&lt;-</span> <span class="fu"><a href="../reference/sample_sparse.html">sample_sparse</a></span><span class="op">(</span><span class="va">latent</span><span class="op">)</span></span>
<span></span>
<span><span class="co"># singular value decomposition of the observed network</span></span>
<span><span class="va">s_obs</span> <span class="op">&lt;-</span> <span class="fu"><a href="https://rdrr.io/pkg/irlba/man/irlba.html" class="external-link">irlba</a></span><span class="op">(</span><span class="va">A</span>, <span class="fl">5</span><span class="op">)</span></span>
<span></span>
<span><span class="co"># difference between population and sample singular values</span></span>
<span><span class="va">s_pop</span><span class="op">$</span><span class="va">d</span> <span class="op">-</span> <span class="va">s_obs</span><span class="op">$</span><span class="va">d</span></span>
<span><span class="co">#&gt; [1] -0.6686638 -1.3409713 -2.3022241  0.8946001 -3.6481462</span></span></code></pre></div>
<p>That’s really it! To run a short simulation study, most of the
remaining work comes down to choosing various losses that you want to
compute and implemeting them in. The following chunk computes several
losses that we might care about:</p>
<ul>
<li>sin Theta loss for subspace spanned by all the singular vectors</li>
<li>sin Theta loss for each individual singular vector</li>
<li>two-to-infinity loss of the singular vectors, both scaled and
unscaled by the square root of the singular values</li>
<li>the spectral norm of the difference between the population and
sample singular values</li>
</ul>
<div class="sourceCode" id="cb3"><pre class="downlit sourceCode r">
<code class="sourceCode R"><span><span class="va">sin_theta_distance</span> <span class="op">&lt;-</span> <span class="kw">function</span><span class="op">(</span><span class="va">u</span>, <span class="va">v</span><span class="op">)</span> <span class="op">{</span></span>
<span>  <span class="va">s</span> <span class="op">&lt;-</span> <span class="fu"><a href="https://rdrr.io/r/base/svd.html" class="external-link">svd</a></span><span class="op">(</span><span class="fu"><a href="https://rdrr.io/pkg/Matrix/man/matmult-methods.html" class="external-link">crossprod</a></span><span class="op">(</span><span class="va">u</span>, <span class="va">v</span><span class="op">)</span><span class="op">)</span></span>
<span>  <span class="fu"><a href="https://rdrr.io/r/base/nrow.html" class="external-link">ncol</a></span><span class="op">(</span><span class="va">u</span><span class="op">)</span> <span class="op">-</span> <span class="fu"><a href="https://rdrr.io/r/base/sum.html" class="external-link">sum</a></span><span class="op">(</span><span class="va">s</span><span class="op">$</span><span class="va">d</span><span class="op">^</span><span class="fl">2</span><span class="op">)</span></span>
<span><span class="op">}</span></span>
<span></span>
<span><span class="va">find_procrustes_rotation</span> <span class="op">&lt;-</span> <span class="kw">function</span><span class="op">(</span><span class="va">X</span>, <span class="va">Y</span><span class="op">)</span> <span class="op">{</span></span>
<span>  <span class="va">s</span> <span class="op">&lt;-</span> <span class="fu"><a href="https://rdrr.io/r/base/svd.html" class="external-link">svd</a></span><span class="op">(</span><span class="fu"><a href="https://rdrr.io/pkg/Matrix/man/matmult-methods.html" class="external-link">crossprod</a></span><span class="op">(</span><span class="va">X</span>, <span class="va">Y</span><span class="op">)</span><span class="op">)</span></span>
<span>  <span class="fu"><a href="https://rdrr.io/pkg/Matrix/man/matmult-methods.html" class="external-link">tcrossprod</a></span><span class="op">(</span><span class="va">s</span><span class="op">$</span><span class="va">v</span>, <span class="va">s</span><span class="op">$</span><span class="va">u</span><span class="op">)</span> <span class="co"># NOTE U, V swap versus next one</span></span>
<span><span class="op">}</span></span>
<span></span>
<span><span class="va">procrustes_align</span> <span class="op">&lt;-</span> <span class="kw">function</span><span class="op">(</span><span class="va">X</span>, <span class="va">Y</span><span class="op">)</span> <span class="op">{</span></span>
<span>  <span class="va">s</span> <span class="op">&lt;-</span> <span class="fu"><a href="https://rdrr.io/r/base/svd.html" class="external-link">svd</a></span><span class="op">(</span><span class="fu"><a href="https://rdrr.io/pkg/Matrix/man/matmult-methods.html" class="external-link">crossprod</a></span><span class="op">(</span><span class="va">X</span>, <span class="va">Y</span><span class="op">)</span><span class="op">)</span></span>
<span>  <span class="va">rotation</span> <span class="op">&lt;-</span> <span class="fu"><a href="https://rdrr.io/pkg/Matrix/man/matmult-methods.html" class="external-link">tcrossprod</a></span><span class="op">(</span><span class="va">s</span><span class="op">$</span><span class="va">v</span>, <span class="va">s</span><span class="op">$</span><span class="va">u</span><span class="op">)</span></span>
<span>  <span class="va">Y</span> <span class="op"><a href="https://rdrr.io/r/base/matmult.html" class="external-link">%*%</a></span> <span class="va">rotation</span></span>
<span><span class="op">}</span></span>
<span></span>
<span><span class="va">two_to_infinity_loss</span> <span class="op">&lt;-</span> <span class="kw">function</span><span class="op">(</span><span class="va">X</span>, <span class="va">Y</span><span class="op">)</span> <span class="op">{</span></span>
<span>  <span class="va">s</span> <span class="op">&lt;-</span> <span class="fu"><a href="https://rdrr.io/r/base/svd.html" class="external-link">svd</a></span><span class="op">(</span><span class="fu"><a href="https://rdrr.io/pkg/Matrix/man/matmult-methods.html" class="external-link">crossprod</a></span><span class="op">(</span><span class="va">X</span>, <span class="va">Y</span><span class="op">)</span><span class="op">)</span></span>
<span>  <span class="va">rotation</span> <span class="op">&lt;-</span> <span class="fu"><a href="https://rdrr.io/pkg/Matrix/man/matmult-methods.html" class="external-link">tcrossprod</a></span><span class="op">(</span><span class="va">s</span><span class="op">$</span><span class="va">v</span>, <span class="va">s</span><span class="op">$</span><span class="va">u</span><span class="op">)</span></span>
<span>  <span class="va">Yrot</span> <span class="op">&lt;-</span> <span class="va">Y</span> <span class="op"><a href="https://rdrr.io/r/base/matmult.html" class="external-link">%*%</a></span> <span class="va">rotation</span></span>
<span>  <span class="va">diff</span> <span class="op">&lt;-</span> <span class="va">X</span> <span class="op">-</span> <span class="va">Yrot</span></span>
<span>  <span class="fu"><a href="https://rdrr.io/r/base/Extremes.html" class="external-link">max</a></span><span class="op">(</span><span class="fu"><a href="https://rdrr.io/r/base/MathFun.html" class="external-link">sqrt</a></span><span class="op">(</span><span class="fu">Matrix</span><span class="fu">::</span><span class="fu"><a href="https://rdrr.io/pkg/Matrix/man/colSums-methods.html" class="external-link">rowSums</a></span><span class="op">(</span><span class="va">diff</span><span class="op">^</span><span class="fl">2</span><span class="op">)</span><span class="op">)</span><span class="op">)</span></span>
<span><span class="op">}</span></span>
<span></span>
<span><span class="va">loss_helper</span> <span class="op">&lt;-</span> <span class="kw">function</span><span class="op">(</span><span class="va">s_pop</span>, <span class="va">s_obs</span><span class="op">)</span> <span class="op">{</span></span>
<span>  <span class="va">u_pop</span> <span class="op">&lt;-</span> <span class="va">s_pop</span><span class="op">$</span><span class="va">u</span></span>
<span>  <span class="va">u_obs</span> <span class="op">&lt;-</span> <span class="va">s_obs</span><span class="op">$</span><span class="va">u</span></span>
<span></span>
<span>  <span class="va">d_pop</span> <span class="op">&lt;-</span> <span class="va">s_pop</span><span class="op">$</span><span class="va">d</span></span>
<span>  <span class="va">d_obs</span> <span class="op">&lt;-</span> <span class="va">s_obs</span><span class="op">$</span><span class="va">d</span></span>
<span></span>
<span>  <span class="va">x_pop</span> <span class="op">&lt;-</span> <span class="va">u_pop</span> <span class="op"><a href="https://rdrr.io/r/base/matmult.html" class="external-link">%*%</a></span> <span class="fu"><a href="https://rdrr.io/r/base/MathFun.html" class="external-link">sqrt</a></span><span class="op">(</span><span class="fu"><a href="https://rdrr.io/r/base/diag.html" class="external-link">diag</a></span><span class="op">(</span><span class="va">d_pop</span><span class="op">)</span><span class="op">)</span></span>
<span>  <span class="va">x_obs</span> <span class="op">&lt;-</span> <span class="va">u_obs</span> <span class="op"><a href="https://rdrr.io/r/base/matmult.html" class="external-link">%*%</a></span> <span class="fu"><a href="https://rdrr.io/r/base/MathFun.html" class="external-link">sqrt</a></span><span class="op">(</span><span class="fu"><a href="https://rdrr.io/r/base/diag.html" class="external-link">diag</a></span><span class="op">(</span><span class="va">d_obs</span><span class="op">)</span><span class="op">)</span></span>
<span></span>
<span>  <span class="co"># spectral norm difference of pop and obs, simplified computation</span></span>
<span>  <span class="co"># since d_pop and d_obs are diagonal</span></span>
<span>  <span class="va">spectral_loss</span> <span class="op">&lt;-</span> <span class="fu"><a href="https://rdrr.io/r/base/Extremes.html" class="external-link">max</a></span><span class="op">(</span><span class="fu"><a href="https://rdrr.io/r/base/MathFun.html" class="external-link">abs</a></span><span class="op">(</span><span class="va">d_pop</span> <span class="op">-</span> <span class="va">d_obs</span><span class="op">)</span><span class="op">)</span></span>
<span>  <span class="va">spectral_loss</span> <span class="op">&lt;-</span> <span class="fu"><a href="https://rdrr.io/pkg/Matrix/man/norm-methods.html" class="external-link">norm</a></span><span class="op">(</span><span class="fu"><a href="https://rdrr.io/r/base/diag.html" class="external-link">diag</a></span><span class="op">(</span><span class="va">d_pop</span><span class="op">)</span> <span class="op">-</span> <span class="fu"><a href="https://rdrr.io/r/base/diag.html" class="external-link">diag</a></span><span class="op">(</span><span class="va">d_obs</span><span class="op">)</span>, type <span class="op">=</span> <span class="st">"F"</span><span class="op">)</span></span>
<span>  <span class="va">spectral_loss_relative</span> <span class="op">&lt;-</span> <span class="fu"><a href="https://rdrr.io/r/base/MathFun.html" class="external-link">abs</a></span><span class="op">(</span><span class="va">d_pop</span> <span class="op">-</span> <span class="va">d_obs</span><span class="op">)</span> <span class="op">/</span> <span class="va">d_pop</span></span>
<span>  </span>
<span>  <span class="va">Wstar</span> <span class="op">&lt;-</span> <span class="fu">find_procrustes_rotation</span><span class="op">(</span><span class="va">u_pop</span>, <span class="va">u_obs</span><span class="op">)</span></span>
<span>  <span class="va">spectral_loss_rotated</span> <span class="op">&lt;-</span> <span class="fu"><a href="https://rdrr.io/pkg/Matrix/man/norm-methods.html" class="external-link">norm</a></span><span class="op">(</span><span class="va">Wstar</span> <span class="op"><a href="https://rdrr.io/r/base/matmult.html" class="external-link">%*%</a></span> <span class="fu"><a href="https://rdrr.io/r/base/diag.html" class="external-link">diag</a></span><span class="op">(</span><span class="va">d_obs</span><span class="op">)</span> <span class="op">-</span> <span class="fu"><a href="https://rdrr.io/r/base/diag.html" class="external-link">diag</a></span><span class="op">(</span><span class="va">d_pop</span><span class="op">)</span> <span class="op"><a href="https://rdrr.io/r/base/matmult.html" class="external-link">%*%</a></span> <span class="va">Wstar</span>, type <span class="op">=</span> <span class="st">"F"</span><span class="op">)</span></span>
<span>  </span>
<span>  <span class="va">k</span> <span class="op">&lt;-</span> <span class="fu"><a href="https://rdrr.io/r/base/nrow.html" class="external-link">ncol</a></span><span class="op">(</span><span class="va">u_pop</span><span class="op">)</span></span>
<span></span>
<span>  <span class="va">column_sin_theta_loss</span> <span class="op">&lt;-</span> <span class="fu"><a href="https://purrr.tidyverse.org/reference/map.html" class="external-link">map_dbl</a></span><span class="op">(</span></span>
<span>    <span class="fl">1</span><span class="op">:</span><span class="va">k</span>,</span>
<span>    \<span class="op">(</span><span class="va">j</span><span class="op">)</span> <span class="op">{</span></span>
<span>      <span class="fu">sin_theta_distance</span><span class="op">(</span><span class="va">u_pop</span><span class="op">[</span>, <span class="va">j</span>, drop <span class="op">=</span> <span class="cn">FALSE</span><span class="op">]</span>, <span class="va">u_obs</span><span class="op">[</span>, <span class="va">j</span>, drop <span class="op">=</span> <span class="cn">FALSE</span><span class="op">]</span><span class="op">)</span></span>
<span>    <span class="op">}</span></span>
<span>  <span class="op">)</span></span>
<span></span>
<span>  <span class="fu"><a href="https://tibble.tidyverse.org/reference/tibble.html" class="external-link">tibble</a></span><span class="op">(</span></span>
<span>    sin_theta_loss <span class="op">=</span> <span class="fu">sin_theta_distance</span><span class="op">(</span><span class="va">u_pop</span>, <span class="va">u_obs</span><span class="op">)</span>,</span>
<span>    u_two_inf_loss <span class="op">=</span> <span class="fu">two_to_infinity_loss</span><span class="op">(</span><span class="va">u_pop</span>, <span class="va">u_obs</span><span class="op">)</span>,</span>
<span>    x_two_inf_loss <span class="op">=</span> <span class="fu">two_to_infinity_loss</span><span class="op">(</span><span class="va">x_pop</span>, <span class="va">x_obs</span><span class="op">)</span>,</span>
<span>    spectral_loss <span class="op">=</span> <span class="va">spectral_loss</span>,</span>
<span>    spectral_loss_rotated <span class="op">=</span> <span class="va">spectral_loss_rotated</span>,</span>
<span>    spectral_loss_relative1 <span class="op">=</span> <span class="va">spectral_loss_relative</span><span class="op">[</span><span class="fl">1</span><span class="op">]</span>,</span>
<span>    spectral_loss_relative2 <span class="op">=</span> <span class="va">spectral_loss_relative</span><span class="op">[</span><span class="fl">2</span><span class="op">]</span>,</span>
<span>    spectral_loss_relative3 <span class="op">=</span> <span class="va">spectral_loss_relative</span><span class="op">[</span><span class="fl">3</span><span class="op">]</span>,</span>
<span>    spectral_loss_relative4 <span class="op">=</span> <span class="va">spectral_loss_relative</span><span class="op">[</span><span class="fl">4</span><span class="op">]</span>,</span>
<span>    spectral_loss_relative5 <span class="op">=</span> <span class="va">spectral_loss_relative</span><span class="op">[</span><span class="fl">5</span><span class="op">]</span>,</span>
<span>    sin_theta_loss1 <span class="op">=</span> <span class="va">column_sin_theta_loss</span><span class="op">[</span><span class="fl">1</span><span class="op">]</span>,</span>
<span>    sin_theta_loss2 <span class="op">=</span> <span class="va">column_sin_theta_loss</span><span class="op">[</span><span class="fl">2</span><span class="op">]</span>,</span>
<span>    sin_theta_loss3 <span class="op">=</span> <span class="va">column_sin_theta_loss</span><span class="op">[</span><span class="fl">3</span><span class="op">]</span>,</span>
<span>    sin_theta_loss4 <span class="op">=</span> <span class="va">column_sin_theta_loss</span><span class="op">[</span><span class="fl">4</span><span class="op">]</span>,</span>
<span>    sin_theta_loss5 <span class="op">=</span> <span class="va">column_sin_theta_loss</span><span class="op">[</span><span class="fl">5</span><span class="op">]</span></span>
<span>  <span class="op">)</span></span>
<span><span class="op">}</span></span></code></pre></div>
<p>With these tools in handle, we can define a simulation runner. Since
this is just a basic simulation, we aren’t too worried about
computational efficiency, and we create a grid of sample sizes, crossed
with replication indices. Then we compute out hearts out.</p>
<div class="sourceCode" id="cb4"><pre class="downlit sourceCode r">
<code class="sourceCode R"><span></span>
<span><span class="va">run_simulation</span> <span class="op">&lt;-</span> <span class="kw">function</span><span class="op">(</span><span class="va">model</span>, <span class="va">num_reps</span> <span class="op">=</span> <span class="fl">30</span><span class="op">)</span> <span class="op">{</span></span>
<span>  <span class="fu"><a href="https://tidyr.tidyverse.org/reference/expand_grid.html" class="external-link">expand_grid</a></span><span class="op">(</span></span>
<span>    n <span class="op">=</span> <span class="fu"><a href="https://rdrr.io/r/base/c.html" class="external-link">c</a></span><span class="op">(</span><span class="fl">100</span>, <span class="fl">180</span>, <span class="fl">330</span>, <span class="fl">600</span>, <span class="fl">1100</span>, <span class="fl">2000</span><span class="op">)</span>,</span>
<span>    reps <span class="op">=</span> <span class="fl">1</span><span class="op">:</span><span class="va">num_reps</span></span>
<span>  <span class="op">)</span> <span class="op">|&gt;</span></span>
<span>    <span class="fu"><a href="https://dplyr.tidyverse.org/reference/mutate.html" class="external-link">mutate</a></span><span class="op">(</span></span>
<span>      pop <span class="op">=</span> <span class="fu"><a href="https://purrr.tidyverse.org/reference/map.html" class="external-link">map</a></span><span class="op">(</span><span class="va">n</span>, <span class="va">model</span><span class="op">)</span>,</span>
<span>      s_pop <span class="op">=</span> <span class="fu"><a href="https://purrr.tidyverse.org/reference/map.html" class="external-link">map</a></span><span class="op">(</span><span class="va">pop</span>, <span class="va">svds</span><span class="op">)</span>,</span>
<span>      A <span class="op">=</span> <span class="fu"><a href="https://purrr.tidyverse.org/reference/map.html" class="external-link">map</a></span><span class="op">(</span><span class="va">pop</span>, <span class="va">sample_sparse</span><span class="op">)</span>,</span>
<span>      s_obs <span class="op">=</span> <span class="fu"><a href="https://purrr.tidyverse.org/reference/map.html" class="external-link">map</a></span><span class="op">(</span><span class="va">A</span>, <span class="va">irlba</span>, <span class="fl">5</span><span class="op">)</span>, <span class="co"># rank five svd,</span></span>
<span>      loss <span class="op">=</span> <span class="fu"><a href="https://purrr.tidyverse.org/reference/map2.html" class="external-link">map2</a></span><span class="op">(</span><span class="va">s_pop</span>, <span class="va">s_obs</span>, <span class="va">loss_helper</span><span class="op">)</span></span>
<span>    <span class="op">)</span></span>
<span><span class="op">}</span></span>
<span></span>
<span><span class="va">sims</span> <span class="op">&lt;-</span> <span class="fu">run_simulation</span><span class="op">(</span><span class="va">model_distinct</span><span class="op">)</span></span>
<span><span class="va">sims</span></span>
<span><span class="co">#&gt; <span style="color: #949494;"># A tibble: 180 × 7</span></span></span>
<span><span class="co">#&gt;        n  reps pop        s_pop        A                s_obs        loss    </span></span>
<span><span class="co">#&gt;    <span style="color: #949494; font-style: italic;">&lt;dbl&gt;</span> <span style="color: #949494; font-style: italic;">&lt;int&gt;</span> <span style="color: #949494; font-style: italic;">&lt;list&gt;</span>     <span style="color: #949494; font-style: italic;">&lt;list&gt;</span>       <span style="color: #949494; font-style: italic;">&lt;list&gt;</span>           <span style="color: #949494; font-style: italic;">&lt;list&gt;</span>       <span style="color: #949494; font-style: italic;">&lt;list&gt;</span>  </span></span>
<span><span class="co">#&gt; <span style="color: #BCBCBC;"> 1</span>   100     1 <span style="color: #949494;">&lt;undrctd_&gt;</span> <span style="color: #949494;">&lt;named list&gt;</span> <span style="color: #949494;">&lt;dsCMatrx[,100]&gt;</span> <span style="color: #949494;">&lt;named list&gt;</span> <span style="color: #949494;">&lt;tibble&gt;</span></span></span>
<span><span class="co">#&gt; <span style="color: #BCBCBC;"> 2</span>   100     2 <span style="color: #949494;">&lt;undrctd_&gt;</span> <span style="color: #949494;">&lt;named list&gt;</span> <span style="color: #949494;">&lt;dsCMatrx[,100]&gt;</span> <span style="color: #949494;">&lt;named list&gt;</span> <span style="color: #949494;">&lt;tibble&gt;</span></span></span>
<span><span class="co">#&gt; <span style="color: #BCBCBC;"> 3</span>   100     3 <span style="color: #949494;">&lt;undrctd_&gt;</span> <span style="color: #949494;">&lt;named list&gt;</span> <span style="color: #949494;">&lt;dsCMatrx[,100]&gt;</span> <span style="color: #949494;">&lt;named list&gt;</span> <span style="color: #949494;">&lt;tibble&gt;</span></span></span>
<span><span class="co">#&gt; <span style="color: #BCBCBC;"> 4</span>   100     4 <span style="color: #949494;">&lt;undrctd_&gt;</span> <span style="color: #949494;">&lt;named list&gt;</span> <span style="color: #949494;">&lt;dsCMatrx[,100]&gt;</span> <span style="color: #949494;">&lt;named list&gt;</span> <span style="color: #949494;">&lt;tibble&gt;</span></span></span>
<span><span class="co">#&gt; <span style="color: #BCBCBC;"> 5</span>   100     5 <span style="color: #949494;">&lt;undrctd_&gt;</span> <span style="color: #949494;">&lt;named list&gt;</span> <span style="color: #949494;">&lt;dsCMatrx[,100]&gt;</span> <span style="color: #949494;">&lt;named list&gt;</span> <span style="color: #949494;">&lt;tibble&gt;</span></span></span>
<span><span class="co">#&gt; <span style="color: #BCBCBC;"> 6</span>   100     6 <span style="color: #949494;">&lt;undrctd_&gt;</span> <span style="color: #949494;">&lt;named list&gt;</span> <span style="color: #949494;">&lt;dsCMatrx[,100]&gt;</span> <span style="color: #949494;">&lt;named list&gt;</span> <span style="color: #949494;">&lt;tibble&gt;</span></span></span>
<span><span class="co">#&gt; <span style="color: #BCBCBC;"> 7</span>   100     7 <span style="color: #949494;">&lt;undrctd_&gt;</span> <span style="color: #949494;">&lt;named list&gt;</span> <span style="color: #949494;">&lt;dsCMatrx[,100]&gt;</span> <span style="color: #949494;">&lt;named list&gt;</span> <span style="color: #949494;">&lt;tibble&gt;</span></span></span>
<span><span class="co">#&gt; <span style="color: #BCBCBC;"> 8</span>   100     8 <span style="color: #949494;">&lt;undrctd_&gt;</span> <span style="color: #949494;">&lt;named list&gt;</span> <span style="color: #949494;">&lt;dsCMatrx[,100]&gt;</span> <span style="color: #949494;">&lt;named list&gt;</span> <span style="color: #949494;">&lt;tibble&gt;</span></span></span>
<span><span class="co">#&gt; <span style="color: #BCBCBC;"> 9</span>   100     9 <span style="color: #949494;">&lt;undrctd_&gt;</span> <span style="color: #949494;">&lt;named list&gt;</span> <span style="color: #949494;">&lt;dsCMatrx[,100]&gt;</span> <span style="color: #949494;">&lt;named list&gt;</span> <span style="color: #949494;">&lt;tibble&gt;</span></span></span>
<span><span class="co">#&gt; <span style="color: #BCBCBC;">10</span>   100    10 <span style="color: #949494;">&lt;undrctd_&gt;</span> <span style="color: #949494;">&lt;named list&gt;</span> <span style="color: #949494;">&lt;dsCMatrx[,100]&gt;</span> <span style="color: #949494;">&lt;named list&gt;</span> <span style="color: #949494;">&lt;tibble&gt;</span></span></span>
<span><span class="co">#&gt; <span style="color: #949494;"># ℹ 170 more rows</span></span></span></code></pre></div>
<p>Now we’d like to summarize the results across the 30 different runs
of the simulation, so we write a short helper to do this as well.</p>
<div class="sourceCode" id="cb5"><pre class="downlit sourceCode r">
<code class="sourceCode R"><span><span class="va">summarize_simulations</span> <span class="op">&lt;-</span> <span class="kw">function</span><span class="op">(</span><span class="va">sims</span><span class="op">)</span> <span class="op">{</span></span>
<span>  <span class="va">sims</span> <span class="op">|&gt;</span></span>
<span>    <span class="fu"><a href="https://tidyr.tidyverse.org/reference/unnest_wider.html" class="external-link">unnest_wider</a></span><span class="op">(</span><span class="fu"><a href="https://rdrr.io/r/base/c.html" class="external-link">c</a></span><span class="op">(</span><span class="va">loss</span><span class="op">)</span><span class="op">)</span> <span class="op">|&gt;</span></span>
<span>    <span class="fu"><a href="https://dplyr.tidyverse.org/reference/select.html" class="external-link">select</a></span><span class="op">(</span><span class="fu"><a href="https://tidyselect.r-lib.org/reference/starts_with.html" class="external-link">contains</a></span><span class="op">(</span><span class="st">"loss"</span><span class="op">)</span>, <span class="fu"><a href="https://tidyselect.r-lib.org/reference/everything.html" class="external-link">everything</a></span><span class="op">(</span><span class="op">)</span><span class="op">)</span> <span class="op">|&gt;</span></span>
<span>    <span class="fu"><a href="https://dplyr.tidyverse.org/reference/summarise.html" class="external-link">summarize</a></span><span class="op">(</span></span>
<span>      <span class="fu"><a href="https://dplyr.tidyverse.org/reference/across.html" class="external-link">across</a></span><span class="op">(</span><span class="fu"><a href="https://tidyselect.r-lib.org/reference/starts_with.html" class="external-link">contains</a></span><span class="op">(</span><span class="st">"loss"</span><span class="op">)</span>, <span class="va">mean</span><span class="op">)</span>,</span>
<span>      .by <span class="op">=</span> <span class="va">n</span></span>
<span>    <span class="op">)</span> <span class="op">|&gt;</span></span>
<span>    <span class="fu"><a href="https://tidyr.tidyverse.org/reference/pivot_longer.html" class="external-link">pivot_longer</a></span><span class="op">(</span></span>
<span>      <span class="fu"><a href="https://tidyselect.r-lib.org/reference/starts_with.html" class="external-link">contains</a></span><span class="op">(</span><span class="st">"loss"</span><span class="op">)</span>,</span>
<span>      names_to <span class="op">=</span> <span class="st">"loss_type"</span>,</span>
<span>      values_to <span class="op">=</span> <span class="st">"loss"</span></span>
<span>    <span class="op">)</span> <span class="op">|&gt;</span></span>
<span>    <span class="fu"><a href="https://dplyr.tidyverse.org/reference/mutate.html" class="external-link">mutate</a></span><span class="op">(</span></span>
<span>      loss_type <span class="op">=</span> <span class="fu"><a href="https://dplyr.tidyverse.org/reference/recode.html" class="external-link">recode</a></span><span class="op">(</span></span>
<span>        <span class="va">loss_type</span>,</span>
<span>        <span class="st">"sin_theta_loss"</span> <span class="op">=</span> <span class="st">"Sin Theta Loss"</span>,</span>
<span>        <span class="st">"u_two_inf_loss"</span> <span class="op">=</span> <span class="st">"U two-inf"</span>,</span>
<span>        <span class="st">"x_two_inf_loss"</span> <span class="op">=</span> <span class="st">"X two-inf"</span>,</span>
<span>        <span class="st">"spectral_loss"</span> <span class="op">=</span> <span class="st">"Spectral"</span>,</span>
<span>        <span class="st">"sin_theta_loss1"</span> <span class="op">=</span> <span class="st">"Sin Theta Loss (column 1)"</span>,</span>
<span>        <span class="st">"sin_theta_loss2"</span> <span class="op">=</span> <span class="st">"Sin Theta Loss (column 2)"</span>,</span>
<span>        <span class="st">"sin_theta_loss3"</span> <span class="op">=</span> <span class="st">"Sin Theta Loss (column 3)"</span>,</span>
<span>        <span class="st">"sin_theta_loss4"</span> <span class="op">=</span> <span class="st">"Sin Theta Loss (column 4)"</span>,</span>
<span>        <span class="st">"sin_theta_loss5"</span> <span class="op">=</span> <span class="st">"Sin Theta Loss (column 5)"</span></span>
<span>      <span class="op">)</span></span>
<span>    <span class="op">)</span></span>
<span><span class="op">}</span></span>
<span></span>
<span><span class="va">results</span> <span class="op">&lt;-</span> <span class="fu">summarize_simulations</span><span class="op">(</span><span class="va">sims</span><span class="op">)</span></span>
<span><span class="va">results</span></span>
<span><span class="co">#&gt; <span style="color: #949494;"># A tibble: 90 × 3</span></span></span>
<span><span class="co">#&gt;        n loss_type                 loss</span></span>
<span><span class="co">#&gt;    <span style="color: #949494; font-style: italic;">&lt;dbl&gt;</span> <span style="color: #949494; font-style: italic;">&lt;chr&gt;</span>                    <span style="color: #949494; font-style: italic;">&lt;dbl&gt;</span></span></span>
<span><span class="co">#&gt; <span style="color: #BCBCBC;"> 1</span>   100 Sin Theta Loss          1.78  </span></span>
<span><span class="co">#&gt; <span style="color: #BCBCBC;"> 2</span>   100 U two-inf               0.538 </span></span>
<span><span class="co">#&gt; <span style="color: #BCBCBC;"> 3</span>   100 X two-inf               1.53  </span></span>
<span><span class="co">#&gt; <span style="color: #BCBCBC;"> 4</span>   100 Spectral                3.78  </span></span>
<span><span class="co">#&gt; <span style="color: #BCBCBC;"> 5</span>   100 spectral_loss_rotated   4.42  </span></span>
<span><span class="co">#&gt; <span style="color: #BCBCBC;"> 6</span>   100 spectral_loss_relative1 0.053<span style="text-decoration: underline;">8</span></span></span>
<span><span class="co">#&gt; <span style="color: #BCBCBC;"> 7</span>   100 spectral_loss_relative2 0.101 </span></span>
<span><span class="co">#&gt; <span style="color: #BCBCBC;"> 8</span>   100 spectral_loss_relative3 0.137 </span></span>
<span><span class="co">#&gt; <span style="color: #BCBCBC;"> 9</span>   100 spectral_loss_relative4 0.294 </span></span>
<span><span class="co">#&gt; <span style="color: #BCBCBC;">10</span>   100 spectral_loss_relative5 0.513 </span></span>
<span><span class="co">#&gt; <span style="color: #949494;"># ℹ 80 more rows</span></span></span></code></pre></div>
<p>And now that we have our results, all that remains is to plot
them.</p>
<div class="sourceCode" id="cb6"><pre class="downlit sourceCode r">
<code class="sourceCode R"><span><span class="va">plot_results</span> <span class="op">&lt;-</span> <span class="kw">function</span><span class="op">(</span><span class="va">results</span><span class="op">)</span> <span class="op">{</span></span>
<span>  <span class="va">results</span> <span class="op">|&gt;</span></span>
<span>    <span class="fu"><a href="https://ggplot2.tidyverse.org/reference/ggplot.html" class="external-link">ggplot</a></span><span class="op">(</span><span class="op">)</span> <span class="op">+</span></span>
<span>    <span class="fu"><a href="https://ggplot2.tidyverse.org/reference/aes.html" class="external-link">aes</a></span><span class="op">(</span>x <span class="op">=</span> <span class="va">n</span>, y <span class="op">=</span> <span class="va">loss</span>, color <span class="op">=</span> <span class="va">loss_type</span><span class="op">)</span> <span class="op">+</span></span>
<span>    <span class="fu"><a href="https://ggplot2.tidyverse.org/reference/geom_path.html" class="external-link">geom_line</a></span><span class="op">(</span><span class="op">)</span> <span class="op">+</span></span>
<span>    <span class="fu"><a href="https://ggplot2.tidyverse.org/reference/scale_continuous.html" class="external-link">scale_x_log10</a></span><span class="op">(</span>labels <span class="op">=</span> <span class="fu"><a href="https://scales.r-lib.org/reference/label_log.html" class="external-link">label_log</a></span><span class="op">(</span>digits <span class="op">=</span> <span class="fl">2</span><span class="op">)</span><span class="op">)</span> <span class="op">+</span></span>
<span>    <span class="fu"><a href="https://ggplot2.tidyverse.org/reference/scale_continuous.html" class="external-link">scale_y_log10</a></span><span class="op">(</span>labels <span class="op">=</span> <span class="fu"><a href="https://scales.r-lib.org/reference/label_log.html" class="external-link">label_log</a></span><span class="op">(</span>digits <span class="op">=</span> <span class="fl">2</span><span class="op">)</span><span class="op">)</span> <span class="op">+</span></span>
<span>    <span class="fu"><a href="https://ggplot2.tidyverse.org/reference/scale_viridis.html" class="external-link">scale_color_viridis_d</a></span><span class="op">(</span>begin <span class="op">=</span> <span class="fl">0.15</span>, end <span class="op">=</span> <span class="fl">0.85</span>, guide <span class="op">=</span> <span class="st">"none"</span><span class="op">)</span> <span class="op">+</span></span>
<span>    <span class="fu"><a href="https://ggplot2.tidyverse.org/reference/facet_wrap.html" class="external-link">facet_wrap</a></span><span class="op">(</span><span class="fu"><a href="https://dplyr.tidyverse.org/reference/vars.html" class="external-link">vars</a></span><span class="op">(</span><span class="va">loss_type</span><span class="op">)</span>, scales <span class="op">=</span> <span class="st">"free_y"</span><span class="op">)</span> <span class="op">+</span></span>
<span>    <span class="fu"><a href="https://ggplot2.tidyverse.org/reference/labs.html" class="external-link">labs</a></span><span class="op">(</span></span>
<span>      title <span class="op">=</span> <span class="st">"Estimation error in adjacency spectral embedding"</span>,</span>
<span>      y <span class="op">=</span> <span class="st">"Estimation error (log scale)"</span>,</span>
<span>      x <span class="op">=</span> <span class="st">"Number of nodes (log scale)"</span></span>
<span>    <span class="op">)</span> <span class="op">+</span></span>
<span>    <span class="fu"><a href="https://ggplot2.tidyverse.org/reference/ggtheme.html" class="external-link">theme_minimal</a></span><span class="op">(</span><span class="op">)</span></span>
<span><span class="op">}</span></span>
<span></span>
<span><span class="fu">plot_results</span><span class="op">(</span><span class="va">results</span><span class="op">)</span></span></code></pre></div>
<p><img src="consistency_files/figure-html/unnamed-chunk-7-1.png" class="r-plt" width="700"></p>
<p>Here we see that all of our losses are decreasing except for the
spectral loss, which is exactly what we would expect from theory.</p>
<p>Since we defined helpers to run the simulations for us, when we want
to see results for the model with repeated eigenvalues, it’s as
straightforward as:</p>
<div class="sourceCode" id="cb7"><pre class="downlit sourceCode r">
<code class="sourceCode R"><span><span class="va">model_repeated</span> <span class="op">|&gt;</span></span>
<span>  <span class="fu">run_simulation</span><span class="op">(</span><span class="op">)</span> <span class="op">|&gt;</span></span>
<span>  <span class="fu">summarize_simulations</span><span class="op">(</span><span class="op">)</span> <span class="op">|&gt;</span></span>
<span>  <span class="fu">plot_results</span><span class="op">(</span><span class="op">)</span></span></code></pre></div>
<p><img src="consistency_files/figure-html/unnamed-chunk-8-1.png" class="r-plt" width="700"></p>
<p>Now we see that we can only recover the subspace spanned by the
singular vectors, but not the singular vectors themselves, exactly as
expected.</p>
<div class="sourceCode" id="cb8"><pre class="downlit sourceCode r">
<code class="sourceCode R"><span><span class="va">spectral_df</span> <span class="op">&lt;-</span> <span class="va">sims</span> <span class="op">|&gt;</span> </span>
<span>  <span class="fu"><a href="https://dplyr.tidyverse.org/reference/mutate.html" class="external-link">mutate</a></span><span class="op">(</span></span>
<span>      diagnostics <span class="op">=</span> <span class="fu"><a href="https://purrr.tidyverse.org/reference/map2.html" class="external-link">map2</a></span><span class="op">(</span><span class="va">s_pop</span>, <span class="va">s_obs</span>, <span class="kw">function</span><span class="op">(</span><span class="va">pop</span>, <span class="va">obs</span><span class="op">)</span> <span class="op">{</span></span>
<span>        <span class="fu"><a href="https://tibble.tidyverse.org/reference/tibble.html" class="external-link">tibble</a></span><span class="op">(</span></span>
<span>          rank <span class="op">=</span> <span class="fl">1</span><span class="op">:</span><span class="fu"><a href="https://rdrr.io/r/base/length.html" class="external-link">length</a></span><span class="op">(</span><span class="va">pop</span><span class="op">$</span><span class="va">d</span><span class="op">)</span>,</span>
<span>          val_pop <span class="op">=</span> <span class="va">pop</span><span class="op">$</span><span class="va">d</span>,</span>
<span>          val_obs <span class="op">=</span> <span class="va">obs</span><span class="op">$</span><span class="va">d</span></span>
<span>        <span class="op">)</span></span>
<span>      <span class="op">}</span><span class="op">)</span></span>
<span>    <span class="op">)</span> <span class="op">|&gt;</span></span>
<span>    <span class="fu"><a href="https://dplyr.tidyverse.org/reference/select.html" class="external-link">select</a></span><span class="op">(</span><span class="va">n</span>, <span class="va">reps</span>, <span class="va">diagnostics</span><span class="op">)</span> <span class="op">|&gt;</span></span>
<span>    <span class="fu"><a href="https://tidyr.tidyverse.org/reference/unnest.html" class="external-link">unnest</a></span><span class="op">(</span><span class="va">diagnostics</span><span class="op">)</span></span>
<span></span>
<span><span class="va">plot_all_scree</span> <span class="op">&lt;-</span> <span class="kw">function</span><span class="op">(</span><span class="va">spectral_df</span><span class="op">)</span> <span class="op">{</span></span>
<span>  <span class="va">spectral_df</span> <span class="op">|&gt;</span></span>
<span>    <span class="fu"><a href="https://tidyr.tidyverse.org/reference/pivot_longer.html" class="external-link">pivot_longer</a></span><span class="op">(</span></span>
<span>      cols <span class="op">=</span> <span class="fu"><a href="https://rdrr.io/r/base/c.html" class="external-link">c</a></span><span class="op">(</span><span class="va">val_pop</span>, <span class="va">val_obs</span><span class="op">)</span>, </span>
<span>      names_to <span class="op">=</span> <span class="st">"type"</span>, </span>
<span>      values_to <span class="op">=</span> <span class="st">"value"</span></span>
<span>    <span class="op">)</span> <span class="op">|&gt;</span></span>
<span>    <span class="fu"><a href="https://dplyr.tidyverse.org/reference/mutate.html" class="external-link">mutate</a></span><span class="op">(</span>type <span class="op">=</span> <span class="fu"><a href="https://dplyr.tidyverse.org/reference/recode.html" class="external-link">recode</a></span><span class="op">(</span><span class="va">type</span>, val_pop <span class="op">=</span> <span class="st">"Population"</span>, val_obs <span class="op">=</span> <span class="st">"Observed"</span><span class="op">)</span><span class="op">)</span> <span class="op">|&gt;</span></span>
<span>    <span class="fu"><a href="https://ggplot2.tidyverse.org/reference/ggplot.html" class="external-link">ggplot</a></span><span class="op">(</span><span class="fu"><a href="https://ggplot2.tidyverse.org/reference/aes.html" class="external-link">aes</a></span><span class="op">(</span>x <span class="op">=</span> <span class="fu"><a href="https://rdrr.io/r/base/factor.html" class="external-link">factor</a></span><span class="op">(</span><span class="va">rank</span><span class="op">)</span>, y <span class="op">=</span> <span class="va">value</span>, color <span class="op">=</span> <span class="va">type</span>, group <span class="op">=</span> <span class="fu"><a href="https://rdrr.io/r/base/interaction.html" class="external-link">interaction</a></span><span class="op">(</span><span class="va">reps</span>, <span class="va">type</span><span class="op">)</span><span class="op">)</span><span class="op">)</span> <span class="op">+</span></span>
<span>    <span class="co"># Jitter slightly to show overlapping replicates</span></span>
<span>    <span class="fu"><a href="https://ggplot2.tidyverse.org/reference/geom_point.html" class="external-link">geom_point</a></span><span class="op">(</span>position <span class="op">=</span> <span class="fu"><a href="https://ggplot2.tidyverse.org/reference/position_jitter.html" class="external-link">position_jitter</a></span><span class="op">(</span>width <span class="op">=</span> <span class="fl">0.1</span><span class="op">)</span>, alpha <span class="op">=</span> <span class="fl">0.5</span>, size <span class="op">=</span> <span class="fl">1.5</span><span class="op">)</span> <span class="op">+</span></span>
<span>    <span class="fu"><a href="https://ggplot2.tidyverse.org/reference/geom_path.html" class="external-link">geom_line</a></span><span class="op">(</span>alpha <span class="op">=</span> <span class="fl">0.3</span><span class="op">)</span> <span class="op">+</span> </span>
<span>    <span class="fu"><a href="https://ggplot2.tidyverse.org/reference/facet_wrap.html" class="external-link">facet_wrap</a></span><span class="op">(</span><span class="op">~</span> <span class="va">n</span>, scales <span class="op">=</span> <span class="st">"free_y"</span>, labeller <span class="op">=</span> <span class="va">label_both</span><span class="op">)</span> <span class="op">+</span></span>
<span>    <span class="fu"><a href="https://ggplot2.tidyverse.org/reference/scale_manual.html" class="external-link">scale_color_manual</a></span><span class="op">(</span>values <span class="op">=</span> <span class="fu"><a href="https://rdrr.io/r/base/c.html" class="external-link">c</a></span><span class="op">(</span><span class="st">"Population"</span> <span class="op">=</span> <span class="st">"#377eb8"</span>, <span class="st">"Observed"</span> <span class="op">=</span> <span class="st">"#e41a1c"</span><span class="op">)</span><span class="op">)</span> <span class="op">+</span></span>
<span>    <span class="fu"><a href="https://ggplot2.tidyverse.org/reference/labs.html" class="external-link">labs</a></span><span class="op">(</span></span>
<span>      title <span class="op">=</span> <span class="st">"Scree Plots: Population vs Observed"</span>,</span>
<span>      subtitle <span class="op">=</span> <span class="st">"Comparing singular values across multiple simulation replicates"</span>,</span>
<span>      x <span class="op">=</span> <span class="st">"Rank (Index)"</span>,</span>
<span>      y <span class="op">=</span> <span class="st">"Singular Value Magnitude"</span>,</span>
<span>      color <span class="op">=</span> <span class="st">"Spectrum"</span></span>
<span>    <span class="op">)</span> <span class="op">+</span></span>
<span>    <span class="fu"><a href="https://ggplot2.tidyverse.org/reference/ggtheme.html" class="external-link">theme_minimal</a></span><span class="op">(</span><span class="op">)</span> <span class="op">+</span></span>
<span>    <span class="fu"><a href="https://ggplot2.tidyverse.org/reference/theme.html" class="external-link">theme</a></span><span class="op">(</span>legend.position <span class="op">=</span> <span class="st">"bottom"</span><span class="op">)</span></span>
<span><span class="op">}</span></span>
<span></span>
<span><span class="fu">plot_all_scree</span><span class="op">(</span><span class="va">spectral_df</span><span class="op">)</span></span></code></pre></div>
<p><img src="consistency_files/figure-html/unnamed-chunk-9-1.png" class="r-plt" width="700"></p>
<p>Here’s one last trick. We might also be interested in using a
different estimator, the Laplacian Spectral Embedding, to recover the
singular value decomposition of the expected (degree-normalized,
regularized) graph Laplacian. This is also straightforward using
<code>fastRG</code>.</p>
<div class="sourceCode" id="cb9"><pre class="downlit sourceCode r">
<code class="sourceCode R"><span><span class="va">graph_laplacian</span> <span class="op">&lt;-</span> <span class="kw">function</span><span class="op">(</span><span class="va">A</span><span class="op">)</span> <span class="op">{</span></span>
<span>  <span class="va">degrees</span> <span class="op">&lt;-</span> <span class="fu"><a href="https://rdrr.io/pkg/Matrix/man/colSums-methods.html" class="external-link">rowSums</a></span><span class="op">(</span><span class="va">A</span><span class="op">)</span></span>
<span>  <span class="va">tau</span> <span class="op">&lt;-</span> <span class="fu"><a href="https://rdrr.io/r/base/mean.html" class="external-link">mean</a></span><span class="op">(</span><span class="va">degrees</span><span class="op">)</span></span>
<span>  <span class="va">DA</span> <span class="op">&lt;-</span> <span class="fu"><a href="https://rdrr.io/pkg/Matrix/man/dimScale.html" class="external-link">rowScale</a></span><span class="op">(</span><span class="va">A</span>, <span class="fl">1</span> <span class="op">/</span> <span class="fu"><a href="https://rdrr.io/r/base/MathFun.html" class="external-link">sqrt</a></span><span class="op">(</span><span class="va">degrees</span> <span class="op">+</span> <span class="va">tau</span><span class="op">)</span><span class="op">)</span></span>
<span>  <span class="fu"><a href="https://rdrr.io/pkg/Matrix/man/dimScale.html" class="external-link">colScale</a></span><span class="op">(</span><span class="va">DA</span>, <span class="fl">1</span> <span class="op">/</span> <span class="fu"><a href="https://rdrr.io/r/base/MathFun.html" class="external-link">sqrt</a></span><span class="op">(</span><span class="va">degrees</span> <span class="op">+</span> <span class="va">tau</span><span class="op">)</span><span class="op">)</span></span>
<span><span class="op">}</span></span>
<span></span>
<span><span class="va">svds_laplacian</span> <span class="op">&lt;-</span> <span class="kw">function</span><span class="op">(</span><span class="va">pop</span><span class="op">)</span> <span class="op">{</span></span>
<span>  <span class="co"># regularize by expected mean degree (scalar)</span></span>
<span>  <span class="va">tau</span> <span class="op">&lt;-</span> <span class="fu"><a href="../reference/expected_edges.html">expected_degree</a></span><span class="op">(</span><span class="va">pop</span><span class="op">)</span></span>
<span>  <span class="co"># vector!!</span></span>
<span>  <span class="va">degrees_pop</span> <span class="op">&lt;-</span> <span class="fu"><a href="../reference/expected_edges.html">expected_degrees</a></span><span class="op">(</span><span class="va">pop</span><span class="op">)</span></span>
<span></span>
<span>  <span class="co"># rescale X in the population model so that XSX' is the expected</span></span>
<span>  <span class="co"># graph Laplacian. we can't use this to sample networks anymore, but</span></span>
<span>  <span class="co"># we can use it to bootstrap a population SVD calculation</span></span>
<span>  <span class="va">pop</span><span class="op">$</span><span class="va">X</span> <span class="op">&lt;-</span> <span class="fu"><a href="https://rdrr.io/pkg/Matrix/man/dimScale.html" class="external-link">rowScale</a></span><span class="op">(</span><span class="va">pop</span><span class="op">$</span><span class="va">X</span>, <span class="fl">1</span> <span class="op">/</span> <span class="fu"><a href="https://rdrr.io/r/base/MathFun.html" class="external-link">sqrt</a></span><span class="op">(</span><span class="va">degrees_pop</span> <span class="op">+</span> <span class="va">tau</span><span class="op">)</span><span class="op">)</span></span>
<span>  <span class="fu"><a href="https://rdrr.io/pkg/RSpectra/man/svds.html" class="external-link">svds</a></span><span class="op">(</span><span class="va">pop</span><span class="op">)</span></span>
<span><span class="op">}</span></span>
<span></span>
<span><span class="va">run_laplacian_simulation</span> <span class="op">&lt;-</span> <span class="kw">function</span><span class="op">(</span><span class="va">model</span>, <span class="va">num_reps</span> <span class="op">=</span> <span class="fl">30</span><span class="op">)</span> <span class="op">{</span></span>
<span>  <span class="fu"><a href="https://tidyr.tidyverse.org/reference/expand_grid.html" class="external-link">expand_grid</a></span><span class="op">(</span></span>
<span>    n <span class="op">=</span> <span class="fu"><a href="https://rdrr.io/r/base/c.html" class="external-link">c</a></span><span class="op">(</span><span class="fl">100</span>, <span class="fl">180</span>, <span class="fl">330</span>, <span class="fl">600</span>, <span class="fl">1100</span>, <span class="fl">2000</span><span class="op">)</span>,</span>
<span>    reps <span class="op">=</span> <span class="fl">1</span><span class="op">:</span><span class="va">num_reps</span></span>
<span>  <span class="op">)</span> <span class="op">|&gt;</span></span>
<span>    <span class="fu"><a href="https://dplyr.tidyverse.org/reference/mutate.html" class="external-link">mutate</a></span><span class="op">(</span></span>
<span>      pop <span class="op">=</span> <span class="fu"><a href="https://purrr.tidyverse.org/reference/map.html" class="external-link">map</a></span><span class="op">(</span><span class="va">n</span>, <span class="va">model</span><span class="op">)</span>,</span>
<span>      s_pop <span class="op">=</span> <span class="fu"><a href="https://purrr.tidyverse.org/reference/map.html" class="external-link">map</a></span><span class="op">(</span><span class="va">pop</span>, <span class="va">svds_laplacian</span><span class="op">)</span>,</span>
<span>      A <span class="op">=</span> <span class="fu"><a href="https://purrr.tidyverse.org/reference/map.html" class="external-link">map</a></span><span class="op">(</span><span class="va">pop</span>, <span class="va">sample_sparse</span><span class="op">)</span>,</span>
<span>      L <span class="op">=</span> <span class="fu"><a href="https://purrr.tidyverse.org/reference/map.html" class="external-link">map</a></span><span class="op">(</span><span class="va">A</span>, <span class="va">graph_laplacian</span><span class="op">)</span>,</span>
<span>      s_obs <span class="op">=</span> <span class="fu"><a href="https://purrr.tidyverse.org/reference/map.html" class="external-link">map</a></span><span class="op">(</span><span class="va">L</span>, <span class="va">irlba</span>, <span class="fl">5</span><span class="op">)</span>, <span class="co"># rank five svd,</span></span>
<span>      loss <span class="op">=</span> <span class="fu"><a href="https://purrr.tidyverse.org/reference/map2.html" class="external-link">map2</a></span><span class="op">(</span><span class="va">s_pop</span>, <span class="va">s_obs</span>, <span class="va">loss_helper</span><span class="op">)</span></span>
<span>    <span class="op">)</span></span>
<span><span class="op">}</span></span></code></pre></div>
<p>With our helpers defined we’re once again off to the races and see
that Laplacian Spectral Embedding also does well</p>
<div class="sourceCode" id="cb10"><pre class="downlit sourceCode r">
<code class="sourceCode R"><span><span class="va">model_distinct</span> <span class="op">|&gt;</span></span>
<span>  <span class="fu">run_laplacian_simulation</span><span class="op">(</span><span class="op">)</span> <span class="op">|&gt;</span></span>
<span>  <span class="fu">summarize_simulations</span><span class="op">(</span><span class="op">)</span> <span class="op">|&gt;</span></span>
<span>  <span class="fu">plot_results</span><span class="op">(</span><span class="op">)</span></span></code></pre></div>
<p><img src="consistency_files/figure-html/unnamed-chunk-11-1.png" class="r-plt" width="700"></p>
  </main>
</div>



    <footer><div class="pkgdown-footer-left">
  <p>Developed by <a href="https://alexpghayes.com" class="external-link">Alex Hayes</a>, Karl Rohe, Jun Tao, Xintian Han, Norbert Binkiewicz.</p>
</div>

<div class="pkgdown-footer-right">
  <p>Site built with <a href="https://pkgdown.r-lib.org/" class="external-link">pkgdown</a> 2.2.0.</p>
</div>

    </footer>
</div>





  </body>
</html>
